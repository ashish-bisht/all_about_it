<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Principal Prep | Learning Mode</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <meta name="theme-color" content="#818cf8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <!-- JetBrains Mono for code -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Highlight.js (GitHub Dark Theme) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <style>
        /* --- Quiz Specifics --- */
        .quiz-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 25px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }

        .quiz-option {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .quiz-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .quiz-option.correct {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--safe);
            color: var(--safe);
        }

        .quiz-option.wrong {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--danger);
            color: var(--danger);
        }

        /* --- Dry Run & Explainer --- */
        .metric-explainer {
            display: none;
            background: var(--bg-card);
            color: #f1f5f9;
            padding: 24px;
            border-radius: var(--radius-md);
            margin: 20px 0;
            font-size: 1.05rem;
            line-height: 1.8;
            border-left: 4px solid var(--primary);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .info-box {
            padding: 25px;
            border-radius: var(--radius-md);
            margin: 30px 0;
            font-size: 1rem;
            position: relative;
            line-height: 1.7;
        }

        .logic-box,
        .trap-box,
        .info-box {
            background: rgba(255, 255, 255, 0.03) !important;
            border-left: 4px solid var(--primary) !important;
            color: var(--text-muted) !important;
        }

        .trap-box {
            border-left-color: var(--danger) !important;
        }

        .box-label {
            position: absolute;
            top: -12px;
            left: 20px;
            background: var(--bg-card);
            color: var(--text-main) !important;
            padding: 2px 12px;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
        }

        /* --- Collapsible Sections (Apple Style) --- */
        .collapsible-section {
            margin-top: 25px;
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.3s ease;
        }

        .collapsible-section:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .collapsible-header {
            padding: 18px 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.03);
            user-select: none;
            transition: all 0.2s ease;
        }

        .collapsible-header:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .collapsible-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .collapsible-header-icon {
            font-size: 1.2rem;
        }

        .collapsible-header-title {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-main);
        }

        .collapsible-arrow {
            color: var(--text-muted);
            font-size: 0.85rem;
            transition: transform 0.3s ease;
        }

        .collapsible-section.open .collapsible-arrow {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .collapsible-section.open .collapsible-content {
            max-height: 2000px;
        }

        .collapsible-inner {
            padding: 24px;
            border-top: 1px solid var(--border);
            line-height: 1.8;
            color: var(--text-muted);
        }

        /* Color variants for different section types */
        .collapsible-section.crux .collapsible-header-icon {
            color: var(--primary);
        }

        .collapsible-section.crux {
            border-left: 3px solid var(--primary);
        }

        .collapsible-section.trap .collapsible-header-icon {
            color: var(--danger);
        }

        .collapsible-section.trap {
            border-left: 3px solid var(--danger);
        }

        .collapsible-section.dryrun .collapsible-header-icon {
            color: var(--warning);
        }

        .collapsible-section.dryrun {
            border-left: 3px solid var(--warning);
        }

        .collapsible-section.visual .collapsible-header-icon {
            color: #22d3ee;
        }

        .collapsible-section.visual {
            border-left: 3px solid #22d3ee;
        }

        .collapsible-section.mentalmodel .collapsible-header-icon {
            color: #a78bfa;
        }

        .collapsible-section.mentalmodel {
            border-left: 3px solid #8b5cf6;
            background: var(--bg-card);
        }

        .collapsible-section.quick-algo {
            border-left: 3px solid #5e5ce6;
        }

        /* --- Quick Algo Steps (Mental Map) --- */
        .quick-algo-section {
            margin-top: 25px;
            background: linear-gradient(135deg, rgba(94, 92, 230, 0.08), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(94, 92, 230, 0.2);
            border-radius: 16px;
            padding: 24px;
            position: relative;
        }

        .quick-algo-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-algo-icon {
            font-size: 1.5rem;
        }

        .quick-algo-title {
            font-weight: 800;
            font-size: 1rem;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quick-algo-steps {
            display: flex;
            flex-direction: column;
            gap: 0;
            position: relative;
        }

        .algo-step {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            position: relative;
            padding-left: 8px;
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.85rem;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(94, 92, 230, 0.3);
            z-index: 1;
        }

        .step-content {
            flex: 1;
            padding: 8px 0 20px 0;
            border-left: 2px dashed rgba(94, 92, 230, 0.3);
            padding-left: 20px;
            margin-left: -25px;
            position: relative;
        }

        .algo-step:last-child .step-content {
            border-left: none;
            padding-bottom: 0;
        }

        .step-text {
            font-size: 0.95rem;
            color: var(--text-main);
            font-weight: 600;
            line-height: 1.5;
        }

        .step-text code {
            background: rgba(0, 0, 0, 0.4);
            color: #a5f3fc;
            padding: 2px 8px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .step-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Arrow connector between steps */
        .algo-step:not(:last-child)::after {
            content: "";
            position: absolute;
            left: 23px;
            top: 36px;
            width: 2px;
            height: calc(100% - 32px);
            background: linear-gradient(to bottom, rgba(94, 92, 230, 0.4), rgba(139, 92, 246, 0.2));
        }

        @media (max-width: 600px) {
            .quick-algo-section {
                padding: 18px;
            }

            .step-number {
                width: 28px;
                height: 28px;
                font-size: 0.75rem;
            }

            .step-text {
                font-size: 0.9rem;
            }
        }

        /* --- Content De-Colorizer REMOVED --- */
        /* Restoring original color hierarchy */

        /* --- Premium Code Block Design (VS Code Style) --- */
        details {
            margin-top: 35px;
            /* background: #1e1e1e; Removed to fit StackOverflow Dark */
            /* VS Code Default Dark */
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        details:hover {
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
            border-color: #444;
        }

        summary {
            background: #252526;
            /* VS Code Header */
            padding: 12px 20px;
            cursor: pointer;
            color: #cccccc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #1e1e1e;
            user-select: none;
            transition: background 0.2s;
        }

        summary:hover {
            background: #2a2d2e;
            color: white;
        }

        /* Mac Window Controls Simulation */
        summary::before {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff5f56;
            /* Red */
            box-shadow: 20px 0 0 #ffbd2e, 40px 0 0 #27c93f;
            /* Yellow, Green */
            margin-right: 15px;
            opacity: 0.8;
        }

        /* Custom Arrow */
        summary::after {
            content: '\f107';
            /* Down Arrow */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: #858585;
            transition: transform 0.2s;
        }

        details[open] summary::after {
            transform: rotate(180deg);
        }

        /* Code Content */
        /* Code Content */
        pre {
            /* Let Highlight.js handle background and color */
            padding: 0 !important;
            font-family: 'Fira Code', 'Menlo', 'Monaco', 'Courier New', monospace;
            /* Mac Monospace */
            font-size: 0.95rem;
            line-height: 1.6;
            overflow-x: auto;
            margin: 0 !important;
            border-top: 1px solid #333;
            position: relative;
        }

        /* Ensure code block fills the container and gets background */
        pre code.hljs {
            display: block;
            padding: 20px !important;
            min-height: 100%;
        }





        /* Ensure spans inside pre inherit correct font */
        pre span {
            font-family: inherit;
        }

        details[open] .copy-btn {
            opacity: 1;
            /* Show when open */
        }

        details:hover .copy-btn {
            opacity: 1;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-1px);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Code Panel (Always Visible) --- */
        .code-panel {
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            margin-top: 20px;
        }

        .code-panel-header {
            background: #252526;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #1e1e1e;
        }

        .code-panel-dots::before {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff5f56;
            box-shadow: 20px 0 0 #ffbd2e, 40px 0 0 #27c93f;
        }

        .code-panel-title {
            flex: 1;
            color: #ccc;
            font-size: 0.9rem;
            font-weight: 500;
            margin-left: 40px;
        }

        .code-panel .copy-btn {
            background: rgba(255,255,255,0.08);
            border: none;
            color: #858585;
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            opacity: 1;
        }

        .code-panel .copy-btn:hover {
            background: rgba(255,255,255,0.15);
            color: #fff;
        }

        /* --- Complexity Panel --- */
        .complexity-panel {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .complexity-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            flex: 1;
        }

        .complexity-item.time {
            border-top: 2px solid #fbbf24;
        }

        .complexity-item.space {
            border-top: 2px solid #a78bfa;
        }

        .complexity-badge {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .complexity-badge i {
            font-size: 0.85rem;
        }

        .complexity-item.time .complexity-badge i { color: #fbbf24; }
        .complexity-item.space .complexity-badge i { color: #a78bfa; }

        .complexity-label {
            color: var(--text-muted);
            font-size: 0.72rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .complexity-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 1rem;
            color: #a5f3fc;
            margin-left: auto;
        }

        .complexity-explain {
            color: var(--text-muted);
            font-size: 0.78rem;
            line-height: 1.45;
            padding-top: 8px;
            margin-top: 8px;
            border-top: 1px solid var(--border);
            max-height: 80px;
            overflow-y: auto;
        }

        .complexity-explain strong {
            color: var(--text-main);
        }

        /* --- Mental Map Structured --- */
        .mental-map-section {
            margin-bottom: 28px;
            background: linear-gradient(135deg, rgba(94, 92, 230, 0.06), rgba(139, 92, 246, 0.03));
            border: 1px solid rgba(94, 92, 230, 0.15);
            border-radius: 14px;
            padding: 22px;
        }

        .section-title {
            font-size: 1.15rem;
            font-weight: 800;
            margin-bottom: 18px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mental-map-steps {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .mm-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 6px 10px;
            border-radius: 8px;
            margin-left: calc(var(--indent, 0) * 20px);
            transition: background 0.15s;
        }

        .mm-step:hover {
            background: rgba(255, 255, 255, 0.04);
        }

        .mm-step-num {
            width: 22px;
            height: 22px;
            background: rgba(94, 92, 230, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            color: #a78bfa;
            flex-shrink: 0;
            margin-top: 3px;
        }

        .mm-step-body {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            min-width: 0;
        }

        .mm-code {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.85rem;
            color: #e2e8f0;
            background: rgba(0, 0, 0, 0.3);
            padding: 3px 8px;
            border-radius: 5px;
            display: inline-block;
            word-break: break-all;
        }

        .mm-comment {
            font-size: 0.78rem;
            color: #8b5cf6;
            font-weight: 500;
            padding-left: 8px;
        }

        /* --- DryRun Timeline --- */
        .dryrun-timeline {
            display: flex;
            flex-direction: column;
            gap: 0;
            position: relative;
            padding-left: 24px;
            border-left: 2px solid rgba(255, 159, 10, 0.2);
            margin-left: 6px;
        }

        .dryrun-step {
            position: relative;
            padding: 8px 0 8px 16px;
        }

        .dryrun-step::before {
            content: '';
            position: absolute;
            left: -30px;
            top: 16px;
            width: 10px;
            height: 10px;
            background: var(--warning);
            border-radius: 50%;
            border: 2px solid var(--bg-dark);
        }

        .dryrun-text {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-muted);
        }

        .dryrun-text strong {
            color: var(--text-main);
        }

        .dryrun-text code {
            background: rgba(0, 0, 0, 0.3);
            color: #a5f3fc;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* --- Trap Section Enhanced --- */
        .trap-content {
            background: rgba(255, 69, 58, 0.05);
            padding: 16px 20px;
            border-left: 3px solid var(--danger);
            border-radius: 0 10px 10px 0;
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-main);
        }

        .trap-content strong {
            color: var(--danger);
        }

        /* --- Stagger Animation for Focus View Sections --- */
        .focus-animate {
            opacity: 0;
            transform: translateY(16px);
            animation: focusFadeIn 0.4s ease forwards;
        }

        .focus-animate:nth-child(1) { animation-delay: 0s; }
        .focus-animate:nth-child(2) { animation-delay: 0.06s; }
        .focus-animate:nth-child(3) { animation-delay: 0.12s; }
        .focus-animate:nth-child(4) { animation-delay: 0.18s; }
        .focus-animate:nth-child(5) { animation-delay: 0.24s; }
        .focus-animate:nth-child(6) { animation-delay: 0.30s; }
        .focus-animate:nth-child(7) { animation-delay: 0.36s; }
        .focus-animate:nth-child(8) { animation-delay: 0.42s; }
        .focus-animate:nth-child(9) { animation-delay: 0.48s; }
        .focus-animate:nth-child(10) { animation-delay: 0.54s; }

        @keyframes focusFadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Toast Notification --- */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(50, 215, 75, 0.95);
            color: #000;
            padding: 10px 24px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.85rem;
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            pointer-events: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* --- Prev/Next Navigation --- */
        .question-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
            gap: 16px;
        }

        .question-nav-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            max-width: 45%;
        }

        .question-nav-btn:hover {
            background: rgba(255,255,255,0.08);
            color: var(--text-main);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .question-nav-btn.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .nav-btn-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            display: block;
        }

        .nav-btn-title {
            color: var(--text-main);
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        /* --- Floating TOC (Jump to Section) --- */
        .focus-toc {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 24px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        .toc-chip {
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.06);
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .toc-chip:hover {
            background: rgba(94, 92, 230, 0.15);
            color: var(--primary);
            border-color: rgba(94, 92, 230, 0.3);
        }

        /* --- Code Line Numbers --- */
        .code-panel pre code.hljs {
            counter-reset: line;
        }

        .code-panel .hljs-ln-numbers {
            user-select: none;
            text-align: right;
            color: #4a5568;
            padding-right: 12px;
            border-right: 1px solid #333;
            margin-right: 12px;
        }

        /* --- Question Tile Quick Info --- */
        .tile-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 4px;
        }

        .tile-complexity {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 500;
            color: #94a3b8;
            letter-spacing: 0.02em;
            background: none;
            border: none;
            padding: 0;
        }

        /* --- Keyboard Shortcut Hint --- */
        .kbd-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            opacity: 0.4;
            transition: opacity 0.3s;
            z-index: 100;
        }

        .kbd-hint:hover {
            opacity: 0.8;
        }

        .kbd {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
        }

        /* --- Strategy Pro Content Improvement --- */
        .pro-content p {
            margin-bottom: 0;
        }

        .pro-content code {
            background: rgba(0, 0, 0, 0.3);
            color: #a5f3fc;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: 'JetBrains Mono', monospace;
        }

        /* --- Visual Intuition Section --- */
        .visual-container {
            background: linear-gradient(145deg, rgba(34, 211, 238, 0.04), rgba(129, 140, 248, 0.03));
            border: 1px solid rgba(34, 211, 238, 0.1);
            border-radius: 14px;
            padding: 0;
            overflow: hidden;
            position: relative;
        }

        .visual-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #22d3ee, #818cf8, #a78bfa);
            z-index: 1;
        }

        .visual-container > div {
            background: transparent !important;
            padding: 20px 24px !important;
            margin: 0 !important;
            border-radius: 0 !important;
        }

        .visual-container strong {
            font-size: 1rem !important;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 14px !important;
            padding: 6px 14px;
            background: rgba(167, 139, 250, 0.1) !important;
            border-radius: 8px;
            border: 1px solid rgba(167, 139, 250, 0.15);
            color: #c4b5fd !important;
        }

        .visual-container code {
            display: block;
            background: rgba(0, 0, 0, 0.3) !important;
            color: #67e8f9 !important;
            padding: 18px 22px !important;
            border-radius: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.84rem;
            line-height: 1.7;
            border: 1px solid rgba(34, 211, 238, 0.06);
            white-space: pre-wrap;
            letter-spacing: 0.01em;
            overflow-x: auto;
        }

        .visual-container pre {
            border: none !important;
            border-top: none !important;
            background: rgba(0, 0, 0, 0.3) !important;
            padding: 18px 22px !important;
            border-radius: 10px;
            margin: 8px 0;
            font-size: 0.84rem;
            line-height: 1.7;
        }

        /* --- Crux text better readability --- */
        .insight-text code {
            background: rgba(94, 92, 230, 0.15);
            color: #c4b5fd;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 0.95rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .insight-text strong {
            color: #fff;
        }

        /* --- Smooth scroll offset for sticky nav --- */
        [id^="sec-"] {
            scroll-margin-top: 80px;
        }

        /* --- Question counter pill in header --- */
        .question-counter {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            background: rgba(94, 92, 230, 0.12);
            color: var(--primary);
            border: 1px solid rgba(94, 92, 230, 0.2);
        }

        /* --- Sidebar + Main Layout for Focus View --- */
        .focus-layout {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: 48px;
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
        }

        .focus-sidebar {
            position: sticky;
            top: 80px;
            align-self: start;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            padding: 16px 0;
        }

        .sidebar-label {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            padding: 0 12px;
            margin-bottom: 12px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 12px;
            border-radius: 10px;
            font-size: 0.82rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            border: 1px solid transparent;
            position: relative;
        }

        .sidebar-link:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-main);
        }

        .sidebar-link.active {
            background: rgba(94, 92, 230, 0.1);
            color: var(--primary);
            border-color: rgba(94, 92, 230, 0.2);
            font-weight: 700;
        }

        .sidebar-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 18px;
            background: var(--primary);
            border-radius: 0 3px 3px 0;
        }

        .sidebar-icon {
            font-size: 0.85rem;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .sidebar-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Sidebar progress */
        .sidebar-progress {
            margin-top: 20px;
            padding: 12px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            border-radius: 10px;
        }

        .sidebar-progress-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .sidebar-progress-bar {
            height: 4px;
            background: rgba(255,255,255,0.08);
            border-radius: 4px;
            overflow: hidden;
        }

        .sidebar-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #8b5cf6);
            border-radius: 4px;
            transition: width 0.3s;
        }

        /* Sidebar quick actions */
        .sidebar-actions {
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .sidebar-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .sidebar-action-btn:hover {
            background: rgba(255,255,255,0.06);
            color: var(--text-main);
            border-color: rgba(255,255,255,0.15);
        }

        .sidebar-action-btn i {
            font-size: 0.8rem;
        }

        .focus-main {
            min-width: 0;
            max-width: 100%;
            width: 100%;
        }

        /* Hide chip TOC on desktop when sidebar exists */
        .focus-layout .focus-toc {
            display: none;
        }

        /* Mobile: hide sidebar, show chip TOC */
        @media (max-width: 1100px) {
            .focus-layout {
                grid-template-columns: 1fr;
                gap: 0;
            }

            .focus-sidebar {
                display: none;
            }

            .focus-layout .focus-toc {
                display: flex;
            }

            .focus-main {
                max-width: 100%;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .header-section h1 {
                font-size: 2rem;
            }

            .pattern-card {
                padding: 20px;
            }

            .pattern-grid {
                grid-template-columns: 1fr;
                gap: 25px;
            }

            .questions-grid {
                grid-template-columns: 1fr;
            }

            .focus-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 20px;
            }

            .focus-body {
                padding: 20px;
            }

            .metrics {
                flex-wrap: wrap;
            }

            .metric-item {
                font-size: 0.9rem;
            }

            pre {
                padding: 15px;
                font-size: 0.8rem;
            }

            .back-btn {
                width: 100%;
                justify-content: center;
            }

            .complexity-panel {
                flex-direction: column;
                gap: 8px;
            }

            .complexity-item {
                padding: 10px 14px;
            }

            .complexity-value {
                font-size: 0.95rem;
            }

            .mental-map-section {
                padding: 14px;
            }

            .mm-step {
                margin-left: calc(var(--indent, 0) * 12px);
            }

            .mm-code {
                font-size: 0.78rem;
            }

            .code-panel-title {
                font-size: 0.8rem;
            }

            .kbd-hint {
                display: none !important;
            }

            .focus-toc {
                padding: 10px 12px;
                gap: 6px;
            }

            .toc-chip {
                font-size: 0.68rem;
                padding: 4px 10px;
            }

            .question-nav-btn {
                padding: 10px 14px;
                font-size: 0.8rem;
            }

            .nav-btn-title {
                max-width: 100px;
                font-size: 0.8rem;
            }

            .tile-meta {
                gap: 6px;
            }

            .tile-complexity {
                font-size: 0.7rem;
            }
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html" class="nav-logo">
                <i class="fas fa-fire"></i> Principal Prep
            </a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Dashboard</a>
                <a href="learn.html" class="nav-link active">Learn</a>
                <a href="flashcard.html" class="nav-link">Flashcards</a>
                <a href="cheatsheet.html" class="nav-link">Cheat Sheet</a>
                <a href="templates.html" class="nav-link">Templates</a>
                <a href="game.html" class="nav-link" style="color: #f472b6 !important;">
                    <i class="fas fa-gamepad"></i> Game
                </a>
            </div>
        </div>
    </nav>

    <!-- Keyboard Hint -->
    <div class="kbd-hint" id="kbd-hint" style="display:none;">
        <span class="kbd">‚Üê ‚Üí</span>
        <span class="kbd">Esc</span>
    </div>

    <div class="container" id="app">
        <div class="nav-bar">
            <a href="index.html" class="back-btn" id="nav-back-btn"><i class="fas fa-arrow-left"></i> Dashboard</a>
        </div>

        <div id="content-loader" style="text-align:center; padding:50px;">
            <i class="fas fa-spinner fa-spin fa-2x" style="color:var(--primary)"></i>
        </div>
    </div>

    <!-- MAIN CONTENT INJECTION TARGETS -->
    <!-- These will be created by JS, but standard structure:
         1. Header
         2. Mental Model
         3. #question-grid
         4. #focus-view
    -->

    <script src="data.js?v=2"></script>
    <script>
        // Store current data globally for easy access
        let currentTopicData = null;

        // --- View Switching Logic ---
        function openQuestion(index) {
            const q = currentTopicData.questions[index];
            const learn = q.learn;

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Hide Grid, Show Focus
            document.getElementById('grid-view-container').style.display = 'none';
            const focusView = document.getElementById('focus-view-container');
            focusView.style.display = 'block';
            document.getElementById('app').classList.add('focus-active');

            // Show Navbar and keyboard hints
            document.querySelector('.navbar').style.display = 'block';
            const kbdHint = document.getElementById('kbd-hint');
            if (kbdHint) kbdHint.style.display = 'flex';

            // Render content into focus view
            const contentDiv = document.getElementById('focus-content');

            if (q.customHtml) {
                // System Design Custom Template Mode
                contentDiv.innerHTML = `
                    <div class="focus-card" style="max-width: 100%;">
                        <div class="focus-header">
                            <div>
                                <h2 style="margin:0; font-size:1.8rem; display:flex; align-items:center; gap:12px;">
                                    <i class="${currentTopicData.icon}" style="color:var(--primary)"></i>
                                    ${q.title}
                                </h2>
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <span class="tile-badge ${q.difficulty === 'Must Do' ? 'must' : (q.difficulty === 'Good to Do' ? 'good' : 'bonus')}">
                                    ${q.difficulty}
                                </span>
                            </div>
                        </div>
                        
                        <div class="focus-body custom-sys-design-body">
                             ${q.customHtml}
                        </div>
                    </div>
                `;
                return;
            }

            // --- NUCLEAR REDESIGN: PRO SHEET LAYOUT ---

            // Helper to render sections cleanly
            const renderSection = (title, icon, content, isHtml = false) => {
                if (!content) return '';
                return `
                <div class="pro-section">
                    <div class="pro-header">
                        <i class="${icon}" style="color:var(--primary)"></i> ${title}
                    </div>
                    <div class="pro-content">
                        ${isHtml ? content : `<p>${content}</p>`}
                    </div>
                </div>`;
            };

            // Build TOC entries dynamically
            const tocItems = [];
            tocItems.push({id: 'sec-crux', label: 'Crux', icon: 'üí°'});
            if (learn.quickAlgo && learn.quickAlgo.length > 0) tocItems.push({id: 'sec-mentalmap', label: 'Mental Map', icon: 'üß†'});
            tocItems.push({id: 'sec-code', label: 'Code', icon: 'üíª'});
            if (learn.visual) tocItems.push({id: 'sec-visual', label: 'Visual', icon: 'üëÅÔ∏è'});
            if (learn.strategy) tocItems.push({id: 'sec-strategy', label: 'Strategy', icon: '‚ôüÔ∏è'});
            if (learn.dryRun) tocItems.push({id: 'sec-dryrun', label: 'Dry Run', icon: '‚ñ∂Ô∏è'});
            if (learn.trap) tocItems.push({id: 'sec-trap', label: 'Traps', icon: '‚ö†Ô∏è'});
            if (learn.codeDetailed) tocItems.push({id: 'sec-deepdive', label: 'Deep Dive', icon: 'üî¨'});

            // Prev/Next question logic
            const prevQ = index > 0 ? currentTopicData.questions[index - 1] : null;
            const nextQ = index < currentTopicData.questions.length - 1 ? currentTopicData.questions[index + 1] : null;

            // Build sidebar links
            const sidebarLinks = [];
            sidebarLinks.push({id: 'sec-crux', label: 'Crux & Complexity', icon: 'fas fa-lightbulb', emoji: 'üí°'});
            if (learn.quickAlgo && learn.quickAlgo.length > 0) sidebarLinks.push({id: 'sec-mentalmap', label: 'Mental Map', icon: 'fas fa-route', emoji: 'üß†'});
            sidebarLinks.push({id: 'sec-code', label: 'Solution Code', icon: 'fas fa-code', emoji: 'üíª'});
            if (learn.visual) sidebarLinks.push({id: 'sec-visual', label: 'Visual', icon: 'fas fa-eye', emoji: 'üëÅÔ∏è'});
            if (learn.strategy) sidebarLinks.push({id: 'sec-strategy', label: 'Strategy', icon: 'fas fa-chess', emoji: '‚ôüÔ∏è'});
            if (learn.dryRun) sidebarLinks.push({id: 'sec-dryrun', label: 'Execution Trace', icon: 'fas fa-play-circle', emoji: '‚ñ∂Ô∏è'});
            if (learn.trap) sidebarLinks.push({id: 'sec-trap', label: 'Common Traps', icon: 'fas fa-exclamation-triangle', emoji: '‚ö†Ô∏è'});
            if (learn.codeDetailed) sidebarLinks.push({id: 'sec-deepdive', label: 'Deep Dive', icon: 'fas fa-microscope', emoji: 'üî¨'});

            contentDiv.innerHTML = `
                <div class="focus-layout">

                <!-- LEFT SIDEBAR -->
                <aside class="focus-sidebar">
                    <div class="sidebar-label">On this page</div>
                    <nav class="sidebar-nav" id="sidebar-nav">
                        ${sidebarLinks.map((s, i) =>
                            '<a class="sidebar-link' + (i === 0 ? ' active' : '') + '" data-target="' + s.id + '" onclick="scrollToSection(\'' + s.id + '\')">' +
                                '<span class="sidebar-icon"><i class="' + s.icon + '"></i></span>' +
                                '<span class="sidebar-text">' + s.label + '</span>' +
                            '</a>'
                        ).join('')}
                    </nav>

                    <div class="sidebar-progress">
                        <div class="sidebar-progress-label">
                            <span>Question</span>
                            <span>${index + 1} / ${currentTopicData.questions.length}</span>
                        </div>
                        <div class="sidebar-progress-bar">
                            <div class="sidebar-progress-fill" style="width:${Math.round(((index + 1) / currentTopicData.questions.length) * 100)}%"></div>
                        </div>
                    </div>

                    <div class="sidebar-actions">
                        ${q.leetcodeUrl ? '<a href="' + q.leetcodeUrl + '" target="_blank" class="sidebar-action-btn"><i class="fas fa-external-link-alt"></i> LeetCode</a>' : ''}
                        ${prevQ ? '<a class="sidebar-action-btn" onclick="openQuestion(' + (index - 1) + ')"><i class="fas fa-arrow-left"></i> ' + prevQ.title + '</a>' : ''}
                        ${nextQ ? '<a class="sidebar-action-btn" onclick="openQuestion(' + (index + 1) + ')"><i class="fas fa-arrow-right"></i> ' + nextQ.title + '</a>' : ''}
                    </div>
                </aside>

                <!-- MAIN CONTENT -->
                <div class="focus-main">
                <div style="padding: 16px 0;">

                    <!-- 1. HEADER (Compact) -->
                    <div class="focus-animate" style="margin-bottom: 24px; border-bottom:1px solid var(--border); padding-bottom:18px;">
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <div>
                                <h1 style="font-size:2.2rem; font-weight:800; letter-spacing:-0.5px; margin-bottom:8px; background: linear-gradient(135deg, #fff 0%, #94a3b8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                    ${q.title}
                                </h1>
                                <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                                     <span style="color:var(--text-muted); font-size:0.9rem; display:flex; align-items:center; gap:6px;">
                                        <i class="${currentTopicData.icon}" style="color:var(--primary)"></i> ${currentTopicData.title}
                                     </span>
                                     <span style="color:var(--border);">|</span>
                                     <span class="tile-badge ${q.difficulty === 'Must Do' ? 'must' : (q.difficulty === 'Good to Do' ? 'good' : 'bonus')}" style="font-size:0.7rem;">
                                        ${q.difficulty}
                                     </span>
                                     ${q.tags ? q.tags.map(t => '<span class="tile-tag" style="font-size:0.7rem;">' + t + '</span>').join('') : ''}
                                </div>
                            </div>

                            <button onclick="backToGrid()" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); color:var(--text-muted); font-size:0.85rem; cursor:pointer; transition:all 0.2s; padding:8px 14px; border-radius:8px; display:flex; align-items:center; gap:6px;" title="Back to List (Esc)">
                                <i class="fas fa-th-large"></i> Grid
                            </button>
                        </div>
                    </div>

                    <!-- TOC (Jump to Section) -->
                    <div class="focus-toc focus-animate">
                        ${tocItems.map(t => '<a class="toc-chip" onclick="document.getElementById(\'' + t.id + '\').scrollIntoView({behavior:\'smooth\', block:\'start\'})">' + t.icon + ' ' + t.label + '</a>').join('')}
                    </div>

                    <!-- 2. CRUX + COMPLEXITY (Side by Side) -->
                    <div class="insight-bar focus-animate" id="sec-crux">
                        <div class="insight-card">
                            <div class="insight-label">The Crux</div>
                            <div class="insight-text">
                                ${learn.crux || "No crux available. Focus on the strategy."}
                            </div>
                        </div>
                        <div class="complexity-panel">
                            <div class="complexity-item time">
                                <div class="complexity-badge">
                                    <i class="fas fa-clock"></i>
                                    <span class="complexity-label">Time</span>
                                    <span class="complexity-value">${learn.metrics.time}</span>
                                </div>
                                ${learn.timeExplainer ? '<div class="complexity-explain">' + learn.timeExplainer + '</div>' : ''}
                            </div>
                            <div class="complexity-item space">
                                <div class="complexity-badge">
                                    <i class="fas fa-database"></i>
                                    <span class="complexity-label">Space</span>
                                    <span class="complexity-value">${learn.metrics.space}</span>
                                </div>
                                ${learn.spaceExplainer ? '<div class="complexity-explain">' + learn.spaceExplainer + '</div>' : ''}
                            </div>
                        </div>
                    </div>

                    <!-- 3. QUICK MENTAL MAP (Structured Walkthrough) -->
                    ${learn.quickAlgo && learn.quickAlgo.length > 0 ? `
                    <div class="mental-map-section focus-animate" id="sec-mentalmap">
                        <div class="section-title"><i class="fas fa-route" style="color:#8b5cf6"></i> Quick Mental Map</div>
                        <div class="mental-map-steps">
                            ${learn.quickAlgo.map((line, i) => {
                                const parts = line.split(/\s+#\s+/);
                                const codePart = parts[0].trimEnd();
                                const commentPart = parts.length > 1 ? parts.slice(1).join(' # ') : '';
                                const indent = codePart.length - codePart.trimStart().length;
                                return '<div class="mm-step" style="--indent:' + Math.floor(indent / 4) + '">' +
                                    '<div class="mm-step-num">' + (i + 1) + '</div>' +
                                    '<div class="mm-step-body">' +
                                        '<code class="mm-code">' + escapeHtml(codePart.trim()) + '</code>' +
                                        (commentPart ? '<span class="mm-comment">' + commentPart + '</span>' : '') +
                                    '</div>' +
                                '</div>';
                            }).join('')}
                        </div>
                    </div>` : ''}

                    <!-- 4. CODE (Visible by Default!) -->
                    <div class="focus-animate" style="margin-bottom:28px;" id="sec-code">
                        <div class="section-title"><i class="fas fa-code" style="color:var(--safe)"></i> Solution Code</div>
                        ${learn.code ? renderCodeSections(learn.code, learn.codeTitle) : ''}
                    </div>

                    <!-- 5. VISUAL (if exists) -->
                    ${learn.visual ? `
                    <div class="pro-section focus-animate" id="sec-visual">
                         <div class="pro-header">
                            <i class="fas fa-eye" style="color:#22d3ee"></i> Visual Intuition
                         </div>
                         <div class="visual-container">${learn.visual}</div>
                    </div>` : ''}

                    <!-- 6. STRATEGY -->
                    ${learn.strategy ? `
                    <div class="pro-section focus-animate" id="sec-strategy">
                        <div class="pro-header">
                            <i class="fas fa-chess" style="color:var(--primary)"></i> Strategy
                        </div>
                        <div class="pro-content"><p>${learn.strategy}</p></div>
                    </div>` : ''}

                    <!-- 7. EXECUTION TRACE (DryRun Timeline) -->
                    ${learn.dryRun ? `
                    <div class="pro-section focus-animate" id="sec-dryrun">
                        <div class="pro-header">
                            <i class="fas fa-play-circle" style="color:var(--warning)"></i> Execution Trace
                        </div>
                        <div class="dryrun-timeline">
                            ${Array.isArray(learn.dryRun)
                                ? learn.dryRun.map((step, i) =>
                                    '<div class="dryrun-step">' +
                                        '<div class="dryrun-text">' + step + '</div>' +
                                    '</div>'
                                ).join('')
                                : '<div class="pro-content">' + learn.dryRun + '</div>'}
                        </div>
                    </div>` : ''}

                    <!-- 8. COMMON TRAPS -->
                    ${learn.trap ? `
                    <div class="pro-section focus-animate" id="sec-trap">
                        <div class="pro-header" style="color:var(--danger); border-color:rgba(255, 69, 58, 0.3);">
                            <i class="fas fa-exclamation-triangle"></i> Common Traps
                        </div>
                        <div class="trap-content">
                            ${learn.trap}
                        </div>
                    </div>` : ''}

                    <!-- 9. DEEP DIVE (Collapsible) -->
                    ${learn.codeDetailed ? `
                    <div class="collapsible-section crux focus-animate" onclick="toggleCollapsible(this)" style="margin-top:24px;" id="sec-deepdive">
                        <div class="collapsible-header">
                            <div class="collapsible-header-left">
                                <span class="collapsible-header-icon"><i class="fas fa-microscope"></i></span>
                                <span class="collapsible-header-title">Line-by-Line Deep Dive</span>
                            </div>
                            <i class="fas fa-chevron-down collapsible-arrow"></i>
                        </div>
                        <div class="collapsible-content">
                            <div class="collapsible-inner" style="padding:0;">
                                <div class="code-panel" style="border:none; border-radius:0; box-shadow:none;">
                                    <div class="code-panel-header">
                                        <span class="code-panel-dots"></span>
                                        <span class="code-panel-title">Detailed Walkthrough</span>
                                        <button class="copy-btn" onclick="event.stopPropagation(); copyCode('focus-code-detailed')"><i class="fas fa-copy"></i> Copy</button>
                                    </div>
                                    <pre><code id="focus-code-detailed" class="language-python">${escapeHtml(learn.codeDetailed)}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>` : ''}

                    <!-- 10. LEETCODE + PREV/NEXT NAV -->
                    <div class="focus-animate" style="margin-top:32px;">
                        ${q.leetcodeUrl ? `
                        <a href="${q.leetcodeUrl}" target="_blank" class="btn btn-primary" style="padding:14px 28px; font-size:1rem; border-radius:50px; margin-bottom:20px; display:inline-flex;">
                            <i class="fas fa-rocket"></i> Solve on LeetCode
                        </a>` : ''}

                        <div class="question-nav">
                            <button class="question-nav-btn ${!prevQ ? 'disabled' : ''}" onclick="${prevQ ? 'openQuestion(' + (index - 1) + ')' : ''}">
                                <i class="fas fa-arrow-left"></i>
                                <div>
                                    <span class="nav-btn-label">Previous</span>
                                    <span class="nav-btn-title">${prevQ ? prevQ.title : 'None'}</span>
                                </div>
                            </button>
                            <span style="color:var(--text-muted); font-size:0.8rem; font-weight:600;">${index + 1} / ${currentTopicData.questions.length}</span>
                            <button class="question-nav-btn ${!nextQ ? 'disabled' : ''}" onclick="${nextQ ? 'openQuestion(' + (index + 1) + ')' : ''}" style="flex-direction:row-reverse; text-align:right;">
                                <i class="fas fa-arrow-right"></i>
                                <div>
                                    <span class="nav-btn-label">Next</span>
                                    <span class="nav-btn-title">${nextQ ? nextQ.title : 'None'}</span>
                                </div>
                            </button>
                        </div>
                    </div>

                </div>
                </div> <!-- /.focus-main -->
                </div> <!-- /.focus-layout -->
            `;

            // Store current question index for keyboard nav
            window._currentQuestionIndex = index;

            // Trigger Highlight.js
            if (window.hljs) {
                hljs.highlightAll();
            }

            // Highlight specific Quick Algo block if it exists (for dynamic content safety)
            const quickAlgoBlock = document.querySelector('.quick-algo code');
            if (quickAlgoBlock) {
                hljs.highlightElement(quickAlgoBlock);
            }

            // Post-process visual section: convert <br>-based content to clean <pre> blocks
            document.querySelectorAll('.visual-container code').forEach(codeEl => {
                // Get text, strip <br> tags, collapse whitespace lines
                let html = codeEl.innerHTML;
                html = html.replace(/<br\s*\/?>\s*<br\s*\/?>/gi, '\n');
                html = html.replace(/<br\s*\/?>/gi, '\n');
                html = html.replace(/&nbsp;/gi, ' ');
                // Remove leading/trailing blank lines
                html = html.replace(/^\s*\n/, '').replace(/\n\s*$/, '');
                codeEl.innerHTML = html;
            });

            // Setup sidebar scroll spy
            setupSidebarObserver();

            // Switch Nav button to "Back to List"
            const navBtn = document.getElementById('nav-back-btn');
            navBtn.innerHTML = '<i class="fas fa-th"></i> Back to List';
            navBtn.onclick = (e) => {
                e.preventDefault();
                backToGrid();
            };
        }

        // Helper to escape HTML before putting into code block
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Helper to render code sections - splits by ##### headers for multiple approaches
        function renderCodeSections(code, defaultTitle) {
            const codeBlocks = code.split(/(?=##### )/);
            if (codeBlocks.length > 1) {
                // Multiple approaches - separate visible code panels
                return codeBlocks.filter(block => block.trim()).map((block, idx) => {
                    const lines = block.split('\n');
                    const titleMatch = lines[0].match(/##### (.+)/);
                    const title = titleMatch ? titleMatch[1] : 'Approach ' + (idx + 1);
                    const codeContent = lines.slice(1).join('\n').trim();
                    return '<div class="code-panel" style="margin-top:' + (idx === 0 ? '0' : '16px') + ';">' +
                        '<div class="code-panel-header">' +
                            '<span class="code-panel-dots"></span>' +
                            '<span class="code-panel-title">' + title + '</span>' +
                            '<button class="copy-btn" onclick="copyCode(\'focus-code-' + idx + '\')"><i class="fas fa-copy"></i> Copy</button>' +
                        '</div>' +
                        '<pre><code id="focus-code-' + idx + '" class="language-python">' + escapeHtml(codeContent) + '</code></pre>' +
                    '</div>';
                }).join('');
            } else {
                // Single code block - visible by default
                return '<div class="code-panel">' +
                    '<div class="code-panel-header">' +
                        '<span class="code-panel-dots"></span>' +
                        '<span class="code-panel-title">' + (defaultTitle || 'Implementation') + '</span>' +
                        '<button class="copy-btn" onclick="copyCode(\'focus-code\')"><i class="fas fa-copy"></i> Copy</button>' +
                    '</div>' +
                    '<pre><code id="focus-code" class="language-python">' + escapeHtml(code) + '</code></pre>' +
                '</div>';
            }
        }



        function filterQuestions(priority) {
            const tiles = document.querySelectorAll('.question-tile');
            const btns = document.querySelectorAll('.filter-btn');

            // Update buttons
            btns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === priority) btn.classList.add('active');
            });

            // Filter tiles
            tiles.forEach(tile => {
                if (priority === 'all' || tile.dataset.priority === priority) {
                    tile.style.display = 'flex';
                } else {
                    tile.style.display = 'none';
                }
            });
        }

        function backToGrid() {
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            document.getElementById('focus-view-container').style.display = 'none';
            document.getElementById('grid-view-container').style.display = 'block';
            document.getElementById('app').classList.remove('focus-active');

            // Hide keyboard hints
            const kbdHint = document.getElementById('kbd-hint');
            if (kbdHint) kbdHint.style.display = 'none';

            // Disconnect sidebar observer
            if (sidebarObserver) sidebarObserver.disconnect();

            // Reset Nav Button
            const navBtn = document.getElementById('nav-back-btn');
            navBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Dashboard';
            navBtn.onclick = null; // Revert to default href behavior
        }

        // Utils
        function toggleExplainer(id) {
            const el = document.getElementById(id + '-explainer');
            if (el) el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }

        // Toggle collapsible sections
        function toggleCollapsible(section) {
            // Stop event from bubbling to prevent multiple triggers
            event.stopPropagation();
            section.classList.toggle('open');
        }

        // Expand all sections
        function expandAllSections() {
            document.querySelectorAll('.collapsible-section').forEach(s => s.classList.add('open'));
        }

        // Collapse all sections
        function collapseAllSections() {
            document.querySelectorAll('.collapsible-section').forEach(s => s.classList.remove('open'));
        }

        function copyCode(id) {
            const text = document.getElementById(id).innerText;
            navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard!'));
        }

        // Toast notification
        function showToast(msg) {
            let toast = document.getElementById('global-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'global-toast';
                toast.className = 'toast';
                document.body.appendChild(toast);
            }
            toast.textContent = msg;
            toast.classList.add('show');
            clearTimeout(toast._timer);
            toast._timer = setTimeout(() => toast.classList.remove('show'), 1800);
        }

        // Scroll to section (sidebar)
        function scrollToSection(id) {
            const el = document.getElementById(id);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Intersection Observer for sidebar active state
        let sidebarObserver = null;
        function setupSidebarObserver() {
            if (sidebarObserver) sidebarObserver.disconnect();

            const sections = document.querySelectorAll('[id^="sec-"]');
            if (!sections.length) return;

            sidebarObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id;
                        document.querySelectorAll('.sidebar-link').forEach(link => {
                            link.classList.toggle('active', link.dataset.target === id);
                        });
                    }
                });
            }, {
                rootMargin: '-80px 0px -60% 0px',
                threshold: 0
            });

            sections.forEach(sec => sidebarObserver.observe(sec));
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            const focusView = document.getElementById('focus-view-container');
            if (!focusView || focusView.style.display === 'none') return;

            if (e.key === 'Escape') {
                e.preventDefault();
                backToGrid();
            }
            if (e.key === 'ArrowLeft' && window._currentQuestionIndex > 0) {
                e.preventDefault();
                openQuestion(window._currentQuestionIndex - 1);
            }
            if (e.key === 'ArrowRight' && window._currentQuestionIndex < currentTopicData.questions.length - 1) {
                e.preventDefault();
                openQuestion(window._currentQuestionIndex + 1);
            }
        });

        // --- Render Logic ---
        function renderPage() {
            const params = new URLSearchParams(window.location.search);
            const topicId = params.get('topic');
            const app = document.getElementById('app');

            if (!topicId || !prepData[topicId]) {
                app.innerHTML = `
                <div class="nav-bar"><a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Dashboard</a></div>
                <div style="text-align:center; padding:50px;">
                    <h1>Topic Not Found</h1>
                </div>`;
                return;
            }

            currentTopicData = prepData[topicId];
            document.title = `Principal Prep | ${currentTopicData.title}`;

            // SPECIAL: Guide Mode (Tabbed sections for Mastery content)
            if (currentTopicData.type === 'guide') {
                const sections = currentTopicData.sections || [];
                let html = `
                    <div class="nav-bar"><a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Dashboard</a></div>
                    <div class="header-section">
                        <h1><i class="${currentTopicData.icon}" style="color:var(--primary)"></i> ${currentTopicData.title}</h1>
                        <p style="color: var(--text-muted); font-size:1.1rem;">${currentTopicData.description}</p>
                    </div>
                    
                    <!-- Section Tabs -->
                    <div class="guide-tabs">
                        ${sections.map((sec, i) => `
                            <button onclick="showGuideSection(${i})" id="guide-tab-${i}" 
                                class="guide-tab ${i === 0 ? 'active' : ''}">
                                ${sec.title}
                            </button>
                        `).join('')}
                    </div>
                    
                    <!-- Section Content -->
                    <div id="guide-sections-container">
                        ${sections.map((sec, i) => `
                            <div id="guide-section-${i}" class="focus-card" style="padding: 40px; display: ${i === 0 ? 'block' : 'none'};">
                                ${sec.content}
                            </div>
                        `).join('')}
                    </div>
                `;
                app.innerHTML = html;

                // Add global function for tab switching
                window.showGuideSection = function (idx) {
                    // Hide all sections, remove active class
                    document.querySelectorAll('[id^="guide-section-"]').forEach(el => el.style.display = 'none');
                    document.querySelectorAll('.guide-tab').forEach(el => el.classList.remove('active'));

                    // Show selected section, add active class
                    document.getElementById('guide-section-' + idx).style.display = 'block';
                    document.getElementById('guide-tab-' + idx).classList.add('active');
                };
                return;
            }

            // --- STANDARD LAYOUT ---
            let html = `
                <div class="nav-bar">
                    <a href="index.html" class="back-btn" id="nav-back-btn"><i class="fas fa-arrow-left"></i> Dashboard</a>
                </div>

                <!-- GRID VIEW CONTAINER -->
                <div id="grid-view-container">
                    <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:16px; margin-bottom:4px;">
                        <div>
                            <h1 style="font-size:1.8rem; font-weight:800; margin:0 0 4px 0; letter-spacing:-0.5px;"><i class="${currentTopicData.icon}" style="color:var(--primary); margin-right:8px; font-size:1.4rem;"></i>${currentTopicData.title}</h1>
                            <p style="color: var(--text-muted); font-size:0.95rem; margin:0; max-width:600px;">${currentTopicData.description}</p>
                        </div>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <span style="color:var(--text-muted); font-size:0.85rem; font-weight:600;">${currentTopicData.questions.length} questions</span>
                        </div>
                    </div>

                    <!-- Topic Progress Bar -->
                    <div style="margin-top:12px;">
                        <div class="progress-track" style="height:5px;">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>

                     <!-- Mental Model -->
                    ${currentTopicData.mentalModel ? `
                    <div class="collapsible-section mentalmodel" style="margin-top:16px;" onclick="toggleCollapsible(this)">
                        <div class="collapsible-header">
                            <div class="collapsible-header-left">
                                <span class="collapsible-header-icon"><i class="fas fa-brain"></i></span>
                                <span class="collapsible-title">Mental Model</span>
                            </div>
                            <i class="fas fa-chevron-down collapsible-arrow"></i>
                        </div>
                        <div class="collapsible-content">
                            <div class="pattern-grid" style="margin-top:10px;">
                                <div class="pattern-col" style="background: rgba(139, 92, 246, 0.08); padding:20px; border-radius:16px; border: 1px solid rgba(139, 92, 246, 0.2);">
                                    <h4 style="color:#a78bfa; margin-bottom:15px; font-size:1rem;"><i class="fas fa-route"></i> When to Apply</h4>
                                    <ul style="padding-left: 0; line-height: 1.8; color:#e2e8f0; list-style:none;">
                                        ${currentTopicData.mentalModel.whenToApply.map(item => `
                                            <li style="margin-bottom:10px; padding:10px 12px; background:rgba(0,0,0,0.2); border-radius:10px; border-left:3px solid #a78bfa;">
                                                <strong style="color:#fff;">${item.label}</strong><br>
                                                <span style="color:#94a3b8; font-size:0.9rem;">${item.desc}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                                <div class="pattern-col" style="background: rgba(251, 191, 36, 0.08); padding:20px; border-radius:16px; border: 1px solid rgba(251, 191, 36, 0.2);">
                                    <h4 style="color:#fbbf24; margin-bottom:15px; font-size:1rem;"><i class="fas fa-shield-alt"></i> Safety Checks</h4>
                                    <ul style="padding-left: 0; line-height: 1.8; color:#e2e8f0; list-style:none;">
                                         ${currentTopicData.mentalModel.safetyCheck.map(item => `
                                            <li style="margin-bottom:10px; padding:10px 12px; background:rgba(0,0,0,0.2); border-radius:10px; border-left:3px solid #fbbf24;">
                                                <strong style="color:#fbbf24;">${item.label}</strong><br>
                                                <span style="color:#94a3b8; font-size:0.9rem;">${item.desc}</span>
                                            </li>
                                         `).join('')}
                                    </ul>
                                </div>
                            </div>
                            ${currentTopicData.mentalModel.patterns ? `
                            <div style="margin-top:30px; background: rgba(16, 185, 129, 0.08); padding:20px; border-radius:16px; border: 1px solid rgba(16, 185, 129, 0.2);">
                                <h4 style="color:#10b981; margin-bottom:15px; font-size:1rem;"><i class="fas fa-table"></i> Pattern Quick Reference</h4>
                                <div style="overflow-x:auto;">
                                    <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
                                        <thead>
                                            <tr style="background:rgba(16, 185, 129, 0.15);">
                                                <th style="padding:12px; text-align:left; color:#10b981; font-weight:600;">Pattern</th>
                                                <th style="padding:12px; text-align:left; color:#10b981; font-weight:600;">Use Case</th>
                                                <th style="padding:12px; text-align:left; color:#10b981; font-weight:600;">Time</th>
                                                <th style="padding:12px; text-align:left; color:#10b981; font-weight:600;">Space</th>
                                                <th style="padding:12px; text-align:left; color:#10b981; font-weight:600;">Key Idea</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${currentTopicData.mentalModel.patterns.map((p, idx) => `
                                                <tr style="background:${idx % 2 === 0 ? 'rgba(0,0,0,0.2)' : 'rgba(0,0,0,0.1)'}">
                                                    <td style="padding:12px; color:#fff; font-weight:600;">${p.algo}</td>
                                                    <td style="padding:12px; color:#cbd5e1;">${p.use}</td>
                                                    <td style="padding:12px;"><code style="background:rgba(251,191,36,0.2); color:#fbbf24; padding:3px 8px; border-radius:6px;">${p.time}</code></td>
                                                    <td style="padding:12px;"><code style="background:rgba(139,92,246,0.2); color:#a78bfa; padding:3px 8px; border-radius:6px;">${p.space}</code></td>
                                                    <td style="padding:12px; color:#94a3b8; font-size:0.8rem;">${p.template || ''}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>` : ''}
                            ${currentTopicData.mentalModel.decisionTree ? `
                            <div style="margin-top:30px;">
                                ${currentTopicData.mentalModel.decisionTree}
                            </div>` : ''}
                            ${currentTopicData.mentalModel.codeTemplates ? `
                            <div style="margin-top:30px;">
                                ${currentTopicData.mentalModel.codeTemplates}
                            </div>` : ''}
                        </div>
                    </div>` : ''}

                    <!-- Filter Bar -->
                    <div class="filter-bar">
                        <button class="filter-btn active" data-filter="all" onclick="filterQuestions('all')">All</button>
                        <button class="filter-btn must" data-filter="Must Do" onclick="filterQuestions('Must Do')">Must Do</button>
                        <button class="filter-btn good" data-filter="Good to Do" onclick="filterQuestions('Good to Do')">Good to Do</button>
                        <button class="filter-btn bonus" data-filter="Bonus" onclick="filterQuestions('Bonus')">Bonus</button>
                    </div>

                    <!-- Question Tiles -->
                    <div class="questions-grid">
                        ${currentTopicData.questions.map((q, idx) => {
                if (!q.learn && !q.customHtml) return '';
                const priorityClass = q.difficulty === 'Must Do' ? 'must' : (q.difficulty === 'Good to Do' ? 'good' : 'bonus');
                const timeC = q.learn && q.learn.metrics ? q.learn.metrics.time : '';
                const spaceC = q.learn && q.learn.metrics ? q.learn.metrics.space : '';
                return `
                            <div class="question-tile ${priorityClass}" data-priority="${q.difficulty}" onclick="openQuestion(${idx})">
                                <div class="tile-header">
                                    <span class="tile-badge ${priorityClass}">${q.difficulty}</span>
                                    <i class="${currentTopicData.icon} tile-icon"></i>
                                </div>
                                <div class="tile-title">${q.title}</div>
                                ${timeC ? `<div class="tile-meta">
                                    <span class="tile-complexity">‚è± ${timeC}</span>
                                    <span class="tile-complexity">üíæ ${spaceC}</span>
                                </div>` : ''}
                                <div class="tile-tags">
                                    ${q.tags.slice(0, 3).map(t => `<span class="tile-tag">${t}</span>`).join('')}
                                </div>
                            </div>
                            `;
            }).join('')}
                    </div>
                </div>

                <!-- FOCUS VIEW CONTAINER -->
                <div id="focus-view-container" class="focus-view">
                    <!-- Content injected by JS -->
                    <div id="focus-content"></div>
                </div>
            `;

            app.innerHTML = html;

            // Handle Deep Linking
            const questionId = params.get('q');
            if (questionId && currentTopicData.questions) {
                const qIndex = currentTopicData.questions.findIndex(q => (q.id === questionId) || (q.title && q.title.toLowerCase().replace(/\s+/g, '-') === questionId));
                if (qIndex !== -1) {
                    openQuestion(qIndex);
                }
            }
        }

        // Start
        renderPage();
    </script>
</body>

</html>